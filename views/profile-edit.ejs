<!DOCTYPE html>
<html>
<head>
    <title>Edit My Profile - SnaccOverflow</title>
    <link rel="icon" href="../images/icon.png" sizes="32x32" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/javascript/react.js"></script>
    <script src="../javascript/profile.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
</head>
<body>
    <script src="/javascript/navbar.js" type="text/javascript"></script>
    <script>
        createNavbar(<%= isLoggedIn %>);
    </script>
    <div class="border">
        <form id="profile-form" action="/api/user/<%= user.username %>" method="PATCH">
            <input type="hidden" name="_method" value="PATCH">
            <input type="text" name="username" value="<%= user.username %>" placeholder="Enter new username">
            <input type="text" name="aboutme" value="<%= user.aboutme %>" placeholder="Enter new aboutme">
            <!-- Add the image input field here -->
            <input type="file" accept="image/*" name="photo">
            <input type="text" name="password" placeholder="Enter new password">
            <input type="password" name="repassword" placeholder="Re-enter new password">
            <button type="submit">Save Changes</button>
        </form>
    </div>

    <script>
        document.getElementById('profile-form').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission behavior

            // Get the form data
            const formData = new FormData(event.target);

            // Check if a file has been selected
            const fileInput = document.querySelector("input[name='photo']");
            if (fileInput.files.length === 0) {
                // If no file is selected, proceed with form submission without uploading an image
                submitForm(formData);
            } else {
                // If a file is selected, upload the image first and then submit the form
                uploadImage(formData);
            }
        });

        // Function to handle image upload
        function uploadImage(formData) {
    let url = "https://script.google.com/macros/s/AKfycbzHrW44F8-PC41XVJyvuyf9dcVVWDjUcSQPpUdCPfZIh6meEEINS7WAAG5vV2PoShvi/exec";
    let file = document.querySelector("input[name='photo']");

    let fr = new FileReader();
    fr.addEventListener('loadend', () => {
        let res = fr.result;
        let spt = res.split("base64,")[1];
        let obj = {
            base64: spt,
            type: file.files[0].type,
            name: file.files[0].name
        }
        fetch(url, {
            method: "POST",
            body: JSON.stringify(obj)
        })
        .then(r => r.text())
        .then(link => {
            console.log("Image link:", link);
            // Pass the image link to the submitForm function
            submitForm(formData, link);
        })
        .catch(error => console.error("Error:", error));
    });
    fr.readAsDataURL(file.files[0]);
}

        // Function to handle form submission
        function submitForm(formData, imageLink) {
    // Add the image link to the formData
    formData.append("photo", imageLink);

    // Send the PATCH request using fetch
    fetch(`/api/user/${encodeURIComponent('<%= user.username %>')}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/profile';
        } else {
            console.error('Failed to update profile. Please try again later.');
        }
    })
    .catch(error => {
        console.error(error);
        // Handle error (if needed)
    });
}
    </script>
</body>
</html>
