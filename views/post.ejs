<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    </script>
    <% if (isLoggedIn) {%>
        <script src="/javascript/react.js" type="text/javascript"></script>
    <%} else {%>
        <script src="/javascript/no_react.js" type="text/javascript">
      
        </script>
                     <%   } %>
</script>
    <script src="/javascript/postView-jean.js"></script>
    <title><%= post.title %></title>
    <link rel="icon" href="../images/icon.png" sizes="32x32" type="image/png">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
  </head>
  <body>
    <script src="/javascript/navbar.js" type="text/javascript"></script>
    <script>
      createNavbar('', <%= isLoggedIn %>);
    </script>
    <div class="border">
      <div class="content_list">
      </div>
      <script>
        let postID = '<%= post._id %>';
        <% if (!post.isDeleted) { %>
          let pauthor = '<%= post.author %>',
              ptitle = '<%= post.title %>',
              pdesc = '<%= post.content %>',
              ppostedDate = new Date('<%= post.createDate %>').toLocaleString();
          let peditedDate = '<%= post.editDate %>';
          if (peditedDate) {
            peditedDate = new Date(peditedDate).toLocaleString();
          } else {
            peditedDate = '- Not Edited'; //not edited
          }
          prating = '<%= post.rating %>', 
          pmedia = '<%= post.media %>';

          let ppfp = '<%= author.pfp_link %>';
          let preactValue = '<%= reactValue %>';
          let isCurrUserTheAuthor = '<%=isCurrUserTheAuthor%>';
          let isLoggedIn = '<%=isLoggedIn%>';
          $('.content_list').append(posthtml(postID, pauthor, ptitle, ppfp, pdesc, ppostedDate, peditedDate, prating, pmedia, preactValue, isCurrUserTheAuthor,'<%=isLoggedIn%>'));
        <% } else { %>
          // Display a message when the post is deleted
          $('.content_list').append('<div>The original post was deleted, but you can still view the comments.</div>');
        <% } %>
      </script>

<% comments.forEach(comment => { %>
  <% if (!comment.isDeleted){ %>
  <script>
      var commentElement = postreply('<%= comment.author %>','<%= comment.userID.ppfp %>','<%= comment.content %>', '<%= comment.rating %>', '<%= comment._id %>','<%= user.username%>',postID,'<%=isLoggedIn%>','<%=comment.userReaction %>');
      $('.border').append(commentElement);
  </script>
  <% } else { %>
  <script>
      var commentElement = postreply("deleted","deleted","The original comment was deleted, but you can still view the comments.", "N/A", '<%= comment._id %>',"visitor",postID,'<%=isLoggedIn%>',0);
      $('.border').append(commentElement);
  </script>
  <% } %>

  <% const processChildComments = (childComments) => {
    childComments.forEach(child => { %>
      <script>
        $(document).ready(function() {
          var parentCommentId = '<%= child.parentCommentID %>';
          console.log("hi " + parentCommentId);
          var username = '<%= child.userID.username %>';
          var ppfp = '<%= child.userID.ppfp %>';
          var content = '<%= child.content %>';
          var rating = '<%= child.rating %>';
          var childId = '<%= child._id %>';
          var user = '<%= user.username %>';
      
          <% if (!child.isDeleted) { %>
            console.log('<%=child.rating%>');
          var replyResult = postreply(username, ppfp, content, rating, childId, user, postID,'<%=isLoggedIn%>','<%=child.userReaction %>');
          <% } else { %>
          var replyResult = postreply("deleted", "deleted", "The original comment was deleted, but you can still view the comments.", "N/A", '<%= child._id %>', "visitor", postID, '<%=isLoggedIn%>');
          <% } %>
      
          <% if (child.parentCommentID === null) { %>
          $('#' + '<%= child._id %>').append(replyResult);
          <% } else { %>
          $('#' + parentCommentId).append(replyResult);
          <% } %>
        });
      </script>
      <% if (child.childComments.length > 0) {
        processChildComments(child.childComments);
      }
    });
  };

  processChildComments(comment.childComments);
%>

<% }); %>
    </div>
  </body>
</html>